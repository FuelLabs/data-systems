{{- $dune := .Values.dune -}}
{{- $name := "dune-init" -}}
{{- $component := "dune" -}}
{{- $pvcName := printf "%s-dune-state" (include "fuel-streams.fullname" .) -}}
{{- $serviceDict := dict "root" . "context" $dune "name" $name "component" $component -}}
{{- if $dune.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "fuel-streams.fullname" . }}-dune-init
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      {{- include "k8s.pod-config" $serviceDict | nindent 6 }}
      containers:
        - name: init
          image: "busybox"
          command: ['sh', '-c', 'echo "Initializing PVC" && touch {{ $dune.storage.mountPath }}/init && sleep 2']
          volumeMounts:
            - name: dune-state
              mountPath: {{ $dune.storage.mountPath }}
      volumes:
        - name: dune-state
          persistentVolumeClaim:
            claimName: {{ $pvcName }}
      restartPolicy: OnFailure
  backoffLimit: 4
{{- end }}
