{{- $webserver := .Values.webserver -}}
{{- $tls := $webserver.tls -}}
{{- if $webserver.enabled -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  {{- include "k8s.resource-metadata" (dict "root" . "context" $webserver "name" "webserver" "component" "webserver") | nindent 2 }}
spec:
  {{- include "k8s.pod-spec-common" (dict "root" . "context" $webserver "name" "webserver") | nindent 2 }}
  template:
    {{- include "k8s.template-metadata" (dict "root" . "context" $webserver "name" "webserver") | nindent 4 }}
    spec:
      {{- include "k8s.pod-config" (dict "root" . "context" $webserver) | nindent 6 }} 
      containers:
        - name: webserver
          image: "{{ $webserver.image.repository }}:{{ $webserver.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ $webserver.image.pullPolicy }}
          {{- include "k8s.container-config" (dict "root" . "context" $webserver) | nindent 10 }}
{{- include "k8s.hpa" (dict "context" . "service" (dict "context" $webserver "name" "webserver" "autoscaling" $webserver.autoscaling)) }}
{{- end }}
{{- $service := $webserver.service }}
{{- if and $webserver.enabled $service.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  {{- include "k8s.resource-metadata" (dict "root" . "context" $service "name" "webserver" "component" "webserver") | nindent 2 }}
spec:
  type: ClusterIP
  ports:
    - appProtocol: tcp
      name: websocket
      port: {{ $service.port }}
      protocol: TCP
      targetPort: webserver
  selector:
    {{- include "fuel-streams.selectorLabels" (dict "name" "webserver" "context" .) | nindent 4 }}
    app.kubernetes.io/component: webserver
{{- end }}
