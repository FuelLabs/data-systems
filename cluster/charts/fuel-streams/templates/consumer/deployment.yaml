{{- $consumer := .Values.consumer -}}
{{- if $consumer.enabled -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  {{- include "k8s.resource-metadata" (dict "root" . "context" $consumer "name" "consumer") | nindent 2 }}
spec:
  {{- include "k8s.pod-spec-common" (dict "root" . "context" $consumer "name" "consumer") | nindent 2 }}
  template:
    {{- include "k8s.template-metadata" (dict "root" . "context" $consumer "name" "consumer") | nindent 4 }}
    spec:
      {{- include "k8s.pod-config" (dict "root" . "context" $consumer) | nindent 6 }} 
      containers:
        - name: consumer
          image: "{{ $consumer.image.repository }}:{{ $consumer.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ $consumer.image.pullPolicy }}
          command: ["/usr/src/sv-consumer"]
          args:
          - "--nats-url"
          - "$(NATS_URL)"
          {{- with $consumer.image.args }}
          {{- toYaml . | nindent 10 }}
          {{- end }}
          {{- include "k8s.container-config" (dict "root" . "context" $consumer) | nindent 10 }}
{{- include "k8s.hpa" (dict "context" . "service" (dict "context" $consumer "name" "consumer" "autoscaling" $consumer.autoscaling)) }}
{{- end }}