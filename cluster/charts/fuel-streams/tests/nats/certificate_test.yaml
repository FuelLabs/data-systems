suite: Testing NATS certificate
templates:
  - templates/nats/certificate.yaml
tests:
  - it: should not create resources when TLS is disabled
    set:
      nats.tls.enabled: false
      nats.dns: "nats.example.com"
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create resources when DNS is not set
    set:
      nats.tls.enabled: true
      nats.dns: ""
    asserts:
      - hasDocuments:
          count: 0

  - it: should create correct ingress validator
    set:
      nats.tls.enabled: true
      nats.dns: "nats.example.com"
      nats.tls.issuer: "letsencrypt-prod"
    asserts:
      - isKind:
          of: Ingress
        documentIndex: 0
      - equal:
          path: metadata.name
          value: RELEASE-NAME-fuel-streams-cert-validator
        documentIndex: 0
      - equal:
          path: spec.rules[0].host
          value: "nats.example.com"
        documentIndex: 0
      - equal:
          path: 'metadata.annotations["cert-manager.io/cluster-issuer"]'
          value: "letsencrypt-prod"
        documentIndex: 0

  - it: should create correct certificate
    set:
      nats.tls.enabled: true
      nats.dns: "nats.example.com"
      nats.tls.issuer: "letsencrypt-prod"
      nats.tls.duration: "2160h"
      nats.tls.renewBefore: "360h"
    asserts:
      - isKind:
          of: Certificate
        documentIndex: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-fuel-streams-ws-cert
        documentIndex: 1
      - equal:
          path: spec.dnsNames[0]
          value: "nats.example.com"
        documentIndex: 1
      - equal:
          path: spec.issuerRef.name
          value: "letsencrypt-prod"
        documentIndex: 1
      - equal:
          path: spec.issuerRef.kind
          value: "ClusterIssuer"
        documentIndex: 1

  - it: should configure certificate timing correctly
    set:
      nats.tls.enabled: true
      nats.dns: "nats.example.com"
      nats.tls.issuer: "letsencrypt-prod"
      nats.tls.duration: "2160h"
      nats.tls.renewBefore: "360h"
    asserts:
      - equal:
          path: spec.duration
          value: "2160h"
        documentIndex: 1
      - equal:
          path: spec.renewBefore
          value: "360h"
        documentIndex: 1
      - equal:
          path: spec.secretName
          value: RELEASE-NAME-fuel-streams-ws-tls
        documentIndex: 1
