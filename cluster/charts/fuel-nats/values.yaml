# Values for the NATS chart
nats:
  config:
    cluster:
      enabled: false
      replicas: 3

    jetstream:
      enabled: true
      fileStore:
        enabled: true
        dir: /data
        pvc:
          enabled: true
          size: 10Gi
          storageClassName: standard

    websocket:
      enabled: true
      port: 8080
      tls:
        enabled: false
        merge:
          no_tls: false
          same_origin: false
          compression: false
          handshake_timeout: "20s"
          no_auth_user: default_user

    monitor:
      enabled: true
      port: 8222

    # Important NATS configuration using merge
    merge:
      jetstream:
        max_file_store: << 10GiB >>
        max_memory_store: << 7168MiB >>
      max_payload: << 8MiB >>
      system_account: SYS
      accounts:
        SYS:
          users:
            - user: system
              password: << $SYSTEM_USER_PASS >>
        USERS:
          jetstream: enabled
          users:
            - user: admin
              password: << $NATS_ADMIN_PASS >>
              permissions:
                publish: ">"
                subscribe: ">"
            - user: default_user
              permissions:
                subscribe: ">"
                publish:
                  deny:
                    - "*.by_id.>"
                    - "*.blocks.>"
                    - "*.transactions.>"
                    - "*.inputs.>"
                    - "*.outputs.>"
                    - "*.receipts.>"
                    - "*.logs.>"
                    - "*.utxos.>"
                    - "$JS.API.STREAM.CREATE.>"
                    - "$JS.API.STREAM.UPDATE.>"
                    - "$JS.API.STREAM.DELETE.>"
                    - "$JS.API.STREAM.PURGE.>"
                    - "$JS.API.STREAM.RESTORE.>"
                    - "$JS.API.STREAM.MSG.DELETE.>"
                    - "$JS.API.CONSUMER.DURABLE.CREATE.>"

  container:
    env:
      GOMEMLIMIT: 14GiB
      NATS_ADMIN_PASS:
        valueFrom:
          secretKeyRef:
            name: nats
            key: NATS_ADMIN_PASS
      SYSTEM_USER_PASS:
        valueFrom:
          secretKeyRef:
            name: nats
            key: SYSTEM_USER_PASS

    merge:
      startupProbe:
        initialDelaySeconds: 60
        periodSeconds: 10
        failureThreshold: 1080  # this * periodSeconds = time for startup timeout ~ 3 hrs for jetstream db recovery
      resources:
        requests:
          cpu: 4
          memory: 4Gi

  service:
    enabled: true
    ports:
      nats:
        enabled: true
      websocket:
        enabled: true
      monitor:
        enabled: true

  natsBox:
    enabled: true
