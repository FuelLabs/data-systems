{{ if not .Values.onlyRequiredBaseServices }}
{{ if .Values.nearApi.enabled }}
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: null
  labels:
    service: near-api
  name: near-api
spec:
  ports:
    - name: grpc
      port: 50051
      protocol: TCP
      targetPort: 50051
  selector:
    service: near-api
  sessionAffinity: None
  type: ClusterIP
status:
  loadBalancer: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: near-api
  labels:
    service: near-api
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      service: near-api
  template:
    metadata:
      labels:
        service: near-api
    spec:
      serviceAccountName: {{ .Values.serviceAccount }}
      #imagePullSecrets:
      #- name: fuel-local
      containers:
      - env:
        - name: HOST
          value: "0.0.0.0"
        - name: PORT
          value: "50051"
        - name: ENV
          value: {{ .Values.nearApi.env }}
        name: near-api
        imagePullPolicy: Always
        image: "{{ .Values.nearApi.image }}:{{ .Values.nearApi.tag }}"
        ports:
          - containerPort: 50051
        readinessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
          #initialDelaySeconds: 5
          periodSeconds: 4
          failureThreshold: 2
          #successThreshold: 1
          timeoutSeconds: 3
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
          initialDelaySeconds: 30
          periodSeconds: 10
          #timeoutSeconds: 3
          failureThreshold: 6
          #successThreshold: 2
        {{- if not .Values.disableResourceLimits }}
        resources:
        {{- .Values.resourceProfile.nearApi | toYaml | nindent 12 }}
        {{- end }}
      enableServiceLinks: false
      restartPolicy: Always
    {{ end }}
    {{ end }}
